<!Doctype html>
<html>
<head>
	<meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<title>确认订单-格瓦拉生活网</title>
	<link rel="stylesheet" type="text/css" href="${staticPath}css/gewara.css?n=ui_layout,wide_pay&v=$VmUtils.jsVersion"/>
	<script type="text/javascript" src="${staticPath}scripts/mootools.js"></script>
	<script type="text/javascript" src="${staticPath}scripts/gewara.js?n=gewara-util,tips,index_even,base_home,page&v=$VmUtils.jsVersion"></script>
	<style type="text/css">
		.text {border-radius:0;}
		.mod_deliver{width:767px; padding:10px 45px 25px;color:#999;overflow:hidden;}
		.sTicket label{cursor:pointer;}
		.ui_frame {padding-top:15px;position:relative;width:100%;}
		.ui_frame .inner{padding:15px 15px 25px;border:1px solid #ffbe9d;}
		.npl{display:inline-block; width:20px; height:12px; overflow:hidden; font-family:"SimSun"; left:35px; position:absolute; top:5px;}
		.npl em{color:#ffbe9d; font-size:21px;}
		.npl span{color:#fff; font-size:21px; position:absolute; top:1px; left:0;}
		
		.siteTicket ul li{line-height:30px;height:30px;}
		/*快递*/
		.ul-66{padding-left:66px;height:100%;height:32px;}
		.ul-66 dt{float:left; width:90px; text-align:right; margin-left:-66px; _margin-left:-33px;}
		.expTicket select,.expTicket textarea{border:1px solid;border-color:#777 #bbb #bbb;}
		.expTicket {color:#333;}
		.expTicket .list_deliver{width:735px;}
		.expTicket .list_deliver li{padding:4px 10px;width:715px;overflow:hidden;position: relative;}
		.expTicket .modeEdit{position: absolute;right:5px;top:3px;font-weight: normal;}
		.expTicket .modeEdit span{cursor: pointer;color:#666}
		.expTicket .list_deliver li.select .modeEdit span{color:#fe5301}
		/*.expTicket .list_deliver li.select{background:#fdfaf3}*/
		.expTicket .list_deliver li label input{margin-right:5px;vertical-align: -2px;}
		.expTicket .modeEdit i{color: #333}
		.expTicket h2{background:transparent;}
		.expTicket h2,.list_deliver li.select label{font-size:12px;font-weight:bold;color:#333;padding-left:0px;}
		.expTicket .edit_deliver{position: relative;overflow: hidden;}
		
		.black{padding:15px 30px; line-height:28px;color:#333;}
		.conitce em{font-size:14px;color:red;}
		.payBox_body_left li.ccP {position:relative;width:100%;}
		.payBox_body_left li.ccP em{position:absolute;top:0;left:0;}
		.payBox_body_left li.changeMobile {height:30px;line-height:30px;padding:5px 20px;background:none;}
		.rCoop .noto {height:15px;overflow:hidden;width:100%;display:block;}
		
		.spNoticeBox{display:inline-block;background:#ffd; border:1px solid #ffcb99; padding:5px 10px;margin-top:10px;}
		.individuation_text{padding:0 45px 25px}
		.individuation_text ul li{float:left;}
		.individuation_text .text{border-radius:5px;}
		.individuation_text span b{color:#f60;}
		.individuation_text span.wlColor b{color:#686868;}
	</style>
</head>
<body>
#set($relatedtag='drama')#set($movieFlag="movieindex")
#set($isIndexBigAd=true)#set($cfgHeader='header')
#parse('include/wide_header.vm')
<div class="ui_layout">
	#set($otherInfoMap=$VmUtils.readJsonToMap($order.otherinfo))
	<div class="inner"  id="orderForm">
		<div #if($item.openseat)class="payStep03"#{else}class="payStep02"#end>
			#parse('include/drama/wide_stepmenu.vm')
		</div>
		<div class="payBox mt20">
			<div class="payBox_header">
				<div class="pad">
					<h2>请选择取票方式</h2>
				</div>
			</div>
			<div class="payBox_body clear">
				<div class="payBox_body_left">
					<div class="mod_deliver">
						#if($VmUtils.contains($orderOther.takemethod,'E') && $orderOther.express && $VmUtils.contains($orderOther.takemethod,'A'))<p>该场次同时支持取票密码<span class="cF60 ml5 mr5">现场取票</span>和<span class="cF60 ml5 mr5">快递送票</span>上门(可能额外收取快递费)，请选择取票方式</p>#end
						<div class="clear sTicket" id="radioTab">
							#if($VmUtils.contains($orderOther.takemethod,'A'))
							<label>
								<input type="radio" value="A" lang="siteTicket" name="selectTicket" class="mr10" />现场取票
							</label>
							#end
							#if($VmUtils.contains($orderOther.takemethod,'E') && $orderOther.express)
							<label style="margin-left:65px;">
								<input id="expTicketInput" type="radio" value="E" lang="expTicket" name="selectTicket" class="mr10" />快递送票
							</label>
							#end
						</div>
						#if($VmUtils.contains($orderOther.takemethod,'A'))
						<div class="ui_frame siteTicket radioTab" id="siteTicket">
							<div class="inner">
								<ul class="ml10">
									<li>取票手机：
										<label for="mobile">
											<b class="fs16 c333" id="mobileText">$!order.mobile</b>
											<input type="text" value="$!order.mobile" style="width:100px;" name="mobile" id="mobile" class="text none">
											<a href="javascript:getOrderMobile()" class="ml5 mr5" id="elGet">修改</a>
											<a href="javascript:modOrderMobile()" class="ml5 mr5 none" id="elSave">保存</a>
											(取票短信可能会被手机软件(如360卫士)拦截，请注意查收！)<br>
										</label>
									</li>
									#if($VmUtils.isNotBlank($!item.takemsg))
									<li class="ui_warning c666">$!item.takemsg</li>
									#end
								</ul>
								<span class="spNoticeBox">取票说明：请提前半小时凭取票密码到场馆东门取票机处打印门票入场</span>
							</div>
							<span class="npl">
								<em>◆</em>
								<span>◆</span>
							</span>
						</div>
						#end
						#if($VmUtils.contains($orderOther.takemethod,'E') && $orderOther.express)
						<div class="ui_frame expTicket radioTab" id="expTicket" style="display:none;">
							<div class="inner">
								#parse('gewapay/drama/wide_express.vm')
								#if($VmUtils.isNotBlank($!item.takemsg))
								<p class="ui_warning c666">$!item.takemsg</p>
								#end
							</div>
							<span class="npl" style="left:100px;">
								<em>◆</em>
								<span>◆</span>
							</span>
							#if($orderOther.ewarning)
							<p class="cRed mt15">注意：你所购买的场次中有部分场次支持“凭密码现场取票”，此部分场次将发送手机取票密码至你的手机，演出开始前请凭取票密码至现场“终端”或“现场工作人员处”凭密码兑换演出票。若支付成功后15分钟没有收到取票密码，请致电：4000-406-506查询。</p>
							#end
						</div>
						#end
					</div>
					#if($orderOther.greetings)
					<div class="individuation_text">
						<ul class="clear">
							<li class="clear"><label class="left">个性化票面：</label>
								<p class="left" id="o_input"><em id="nt"></em>
								<input type="text" class="text #if($VmUtils.isNotBlank($otherInfoMap.get('greetings'))) none #end" name="greeting" id="greeting" value="$!otherInfoMap.get('greetings')"/>
								<span class="ml5 #if($VmUtils.isNotBlank($otherInfoMap.get('greetings'))) none #end" id="fontN">你还可以输入<b>10</b>字</span></p>
								<p class="left #if($VmUtils.isBlank($otherInfoMap.get('greetings'))) none #end" id="greetingText">
									<span class="cF60 fs14 bold">$!otherInfoMap.get('greetings')</span>
								</p>
							</li>
							<li class="ml10 clear">
								<a class="button bigBt redBt left #if($VmUtils.isNotBlank($otherInfoMap.get('greetings'))) none #end" href="javascript:modOrderGreetings();" id="btn_Save">
									<span>保&nbsp;&nbsp;存</span>
								</a>
								<a class="button bigBt redBt left #if($VmUtils.isBlank($otherInfoMap.get('greetings'))) none #end" href="javascript:getOrderGreetings()" id="btn_Get">
									<span>修&nbsp;&nbsp;改</span>
								</a>
								<span class="left ml5">你可以在此处填写10个字内的文字显示在票面上</span>
							</li>
						</ul>
					</div>
					#end
				</div>
				<div class="payBox_body_right">
					<div class="limitTimedetail inner">
						<p><span class="fs14 cred">请在15分钟内完成付款</span>，超时系统将自动释放已选座位，支付中如遇到问题请致电：<b>4000-406-506</b></p>
						<div class="limitTime">
							<h3 class="fs14">剩余支付时间：</h3>
							<p class="fs22" id="CountMsg"><b id="RemainM">15</b><b>分</b><b id="RemainS">00</b><b>秒</b></p>
						</div>
					</div>
				</div>
			</div>
		</div>
		
		<div class="payBox mt20">
			<div class="payBox_header">
				<div class="pad">
					<h2>确认订单信息</h2>
				</div>
			</div>
			<div class="payBox_body clear">
				<div class="payBox_body_left" style="min-height:135px;_height:135px;">
					<dl class="ui_media">
						<dt class="ui_pic"><img width="72" height="96" alt="$!{drama.name}" src="$VmUtils.randomPic('cw72h96',$!drama.limg)" /></dt>
						<dd class="ui_text">
							<ul>
								<li><em>剧目：</em>$!drama.name</li>
								<li><em>场馆：</em>$!theatre.name</li>
							</ul>
						</dd>
					</dl>
					<ol>
						<li><em>订单号：</em>$!order.tradeNo</li>
						<li class="ccP">
							<em>#if($item.openseat)座位#{else}场次#{end}：</em>
							<div style="padding-left:40px;">
							#if($item.openseat)
								#set($description=$VmUtils.readJsonToMap($order.description2))
								#if(!$VmUtils.isNull($description.get('座位')))
									<font class="fs14">
										<span class="mr15">
											<span class="cF60 mr10">$!description.get('座位')</span>
										</span>
									</font>
								#end
								#set($otherFeeMap=$VmUtils.readJsonToMap($!order.otherFeeRemark))
							#else
								#foreach($item in $buyList)
								#set($odi=$odiMap.get($item.relatedid))
								#set($price=$priceMap.get($item.smallitemid))
								#if(!$VmUtils.isNull($item.disid))
								#set($discount=$disMap.get($item.disid))
								#end
								“<span class="cF60">
									#if($!VmUtils.eq($!odi.period, 'Y'))
										$!odi.name $!DateUtil.formatDate($!odi.playtime) $!DateUtil.getCnWeek($!odi.playtime) $!DateUtil.format($!odi.playtime,'HH:mm')
									#else
										$!odi.name
									#end
								</span>” 
								#if(!$VmUtils.isNull($item.disid))
								“<span class="cF60">$!{discount.price}元(含$!{price.price}元票 x $!{discount.quantity}张)</span>” 数量：<span class="cF60">$!math.div($!item.quantity,$!{discount.quantity})</span>张
								#else
								“<span class="cF60">${price.price}元</span>” 数量：<span class="cF60">$!{item.quantity}</span>张
								#end
								<br/>
								#end
							#end
							</div>
						</li>
						#if(!$VmUtils.isNull($description.get('套票')))
						<li><em>套票：</em><span class="cF60 ffst">$!description.get('套票')</span></li>
						#end
						<li class="mt20">
							#set($otherFeeMap=$VmUtils.readJsonToMap($!order.otherFeeRemark))
							#set($orderprice=${order.due})
							#if($VmUtils.contains($orderOther.takemethod,'E') && $orderOther.express)
							#set($eprice=0)
								#if($otherFeeMap.get('E'))
							#set($eprice=$math.toInteger($!otherFeeMap.get('E')))
								#end
							#set($orderprice=$math.sub(${order.due},$eprice))
							#end
							<em>订单金额：</em><span class="ui_price">¥<b>$orderprice</b></span><em>元</em>
							#if($VmUtils.contains($orderOther.takemethod,'E') && $orderOther.express)
							<em style="padding-left:50px;">运费：</em><span class="ui_price">¥<b id="expressid">#if($otherFeeMap.get('E'))$!otherFeeMap.get('E')#{else}0#end</b></span>
							#end
						</li>
					</ol>
				</div>
				<div class="payBox_body_right"></div>
			</div>
		</div>
		
		<div class="payBox mt20">
			<div class="payBox_header">
				<div class="pad">
					<h2>使用优惠支付</h2> <em class="c999">(以下优惠只能享用一种)</em>
				</div>
			</div>
			<div class="payBox_body clear">
				<div class="paymentTerm" id="discountPanel">
					<input type="hidden" value="$order.id" name="orderId"/> 
					#if($orderOther.openPointPay)
					<dl class="clear mt10">
						<dt class="select" lang="creditsArrived"><b class="freeTag1">积分抵值</b></dt>
						<dd id="creditsArrived" class="">
							<p>
								<input type="radio" style="visibility:hidden; display:none;" value="point" name="discounttype" class="mr5" alt="积分抵值支付" #if($pointDiscount)checked="checked"#elseif($VmUtils.size($cardDiscountList) gt 0 || $partnerDiscount || $memberpoint lt $orderOther.minpoint) disabled="disabled"#else #end id="radio2" />
								你的可用积分为<b class="cf60">$memberpoint</b>点，本场次使用范围：$orderOther.minpoint～$orderOther.maxpoint点(最多抵用<span class="cf60">现金#set($maxPointFee = $orderOther.maxpoint/100)$!maxPointFee元</span>)
							</p>
							#if($memberpoint lt $orderOther.minpoint)<span style="font-weight:normal;color:#666">（你的积分不足，无法使用）</span>#end
							#if($pointDiscount)
							<div>你使用积分抵用了<b>$pointDiscount.amount</b>元, 若选择其他优惠方式，请先
							<input type="button" value="取消" class="bt2 cancle" id="submitpoint" onclick="removeDiscount($pointDiscount.id);"/>
							</div>
							#elseif($orderOther.openPointPay && $memberpoint ge $orderOther.minpoint && !$pointDiscount)
							#set($maxDeduct=$orderOther.maxpoint/100) #set($mpoint=$memberpoint/100*100) #set($omax=$order.due*100)
							#set($pmax=$math.min($orderOther.maxpoint, $mpoint)) #set($maxpoint=$math.min($omax,$pmax))
							<p class="mt10">
								我要使用：<span class="delcredits exeSub"></span>
								<input type="text" size="20" value="500" name="usepoint" id="usepoint" style="width:50px;font-size:18px;font-weight:bold;color:#333" class="text" />
								<span class="addcredits exeSub sub"></span>
								&nbsp;点&nbsp;<span class="m5">抵扣<b class="fs14 cf60 m5" id="useMoney">5</b>元</span> 
								<label class="button bigBt redBt" style="vertical-align: middle;">
									<input type="button" value="使用" class="bt1" id="submitpoint"/>
								</label>
							</p>
							#end
						</dd>
					</dl>
					#end
					#if($orderOther.openCardPay)
					#set($cardCount = $VmUtils.size($cardDiscountList) + $VmUtils.size($cardList))
					<dl class="clear mt10">
						<dt lang="movieCard"><b class="freeTag1">演出票券抵值</b></dt>
						<dd id="movieCard" class="none">
							<div class="inner msC">
								<div class="ui_media">
									<div class="ui_pic" style="height:30px; line-height:30px;">
										<input type="radio" style="visibility:hidden; display:none;" value="card" name="discounttype" class="mr5" alt="演出票券抵值支付" id="radio1" #if($pointDiscount || $partnerDiscount) disabled="disabled" #end #if($VmUtils.size($cardDiscountList) gt 0)checked="checked"#end />
										<label for="radio1">票券密码：</label>
									</div>
									<div class="ui_text" style="position:relative;">
										<input type="text" id="cardpass" size="20" style="width:200px;font-size:16px;font-weight:bold;color:#333" class="text" />
										<label for="cardpass" class="cardpass" style="display:block;top:6px;">请输入12位或16位票券密码</label>
										<label class="button bigBt redBt ml10" style="vertical-align: middle;">
											<input type="button" value="使用" class="bt1 mr5" onclick="useCardByPass($('cardpass').value,this)" />
										</label>
									</div>
								</div>
								<div class="orderTable mt20 #if($cardCount && $cardCount lt 1)none#end" id="orderTable">
									<table width="100%" cellspacing="0" cellpadding="0" border="0">
										<tr>
											<th>卡号</th>
											<th>截止日期</th>
											<th>类型</th>
											<th>抵值</th>
											<th class="center" width="70">操作</th>
										</tr>
										<tbody id="cardTable">
											#if($VmUtils.gt($cardCount, 0))
												#set($cardnoIdList=[])
												#if($VmUtils.size($cardDiscountList) gt 0)
													#foreach($discount in $cardDiscountList)
													#set($tmp=$cardnoIdList.add("${cardMap.get($discount.id).cardno}"))
												<tr #if($foreach.index eq 0)class="select"#end id="${cardMap.get($discount.id).cardno}" >
													<td>$cardMap.get($discount.id).cardno</td>
													<td>$!{DateUtil.format($cardMap.get($discount.id).timeto, "yyyy-MM-dd")}</td>
													<td>#if($!VmUtils.eq($card.ebatch.cardtype,'A'))兑换券 #else 优惠券#end</td>
													<td id="${cardMap.get($discount.id).cardno}amount">$cardMap.get($discount.id).gainUsage()</td>
													<td class="center">
														<label class="button bigBt bigWhiteBt" style="vertical-align: middle;">
															<input type="button"  id="${cardMap.get($discount.id).cardno}button" value="取消" class="bt2 cancel" onclick="removeCard($discount.id, '$cardMap.get($discount.id).cardno',this);" />
														</label>
													</td>
												</tr>
													#end
												#end
												#if($VmUtils.size($cardList) gt 0)
													#foreach($card in $cardList)
													<tr id="${card.cardno}">
														<td>$card.cardno</td>
														<td>$!{DateUtil.format($card.timeto, "yyyy-MM-dd")}</td>
														<td>#if($!VmUtils.eq($card.ebatch.cardtype,'A'))兑换券 #else 优惠券#end</td>
														<td id="${card.cardno}amount">$card.gainUsage()</td>
														<td  align="center">
															<label id="${card.cardno}button" class="button bigBt redBt" style="vertical-align: middle;">
																<input type="button" class="bt1" value="使用" onclick="showCard('$card.cardno',this)"/>
															</label>
														</td>
													</tr>
													#end
												#end
										#end
										</tbody>
									</table>
									#if($VmUtils.gt($cardCount, 3))<div class="plugP"><div id="triggerPlug" class="plugS"><span>收起所有票券<label class="gray">($cardCount)</label></span></div></div>#end
								</div>
								<p class="mt10"><span class="cred">* </span>说明：<span class="yellow">兑换类票券可以使用多张</span>，优惠类票券只能使用一张。</p>
							</div>
						</dd>
					</dl>
					#end
					#if($VmUtils.size($spdiscountList) gt 0)
					<dl class="clear mt10">
						<dt lang="officialActivities"><b class="freeTag1">优惠活动</b></dt>
						<dd class="officialActivities none" id="officialActivities">
							#foreach($spdiscount in $spdiscountList)
							#if($disabledSdMap.containsKey($spdiscount.id))
							<div class="rCoop rCoopDis #if($foreach.index %2 eq 0) mr10 #end">
								<div class="box">
									<input type="radio" disabled="disabled" style="visibility:hidden" class="mr5" name="test" />
									<div class="ui_media">
										<div id="img$spdiscount.id" class="ui_pic">
											<img width="90" height="30" src="$VmUtils.randomPic('',$!spdiscount.limg)" />
										</div>
										<div class="ui_text">
											<span class="noto" id="title$spdiscount.id">$!spdiscount.getFullEnableRemark($order.totalAmount, $discountAmountMap.get($spdiscount.id))</span>
											<div lang="introduce$!spdiscount.id" class="note introduce" id="detail$spdiscount.id">
												$!disabledSdMap.get($spdiscount.id)
											</div>	
										</div>
									</div>
								</div>
								<div class="none">
									<span>$!spdiscount.description</span>
									<span>$!spdiscount.timefrom 至 $!spdiscount.timeto</span>
									<span>$!spdiscount.getFullEnableRemark($order.totalAmount, $discountAmountMap.get($spdiscount.id))</span>
								</div>
							</div>
							#else
							<div rel="$!spdiscount.bindmobile" lang="check$!spdiscount.flag" class="rCoop enableds #if($foreach.index %2 eq 0) mr20 #end">
								<div class="box">
									<input type="radio" style="visibility:hidden" name="discounttype" id="check$spdiscount.flag" value="$spdiscount.id"/>
									<div class="ui_media">
										<div id="img$spdiscount.id" class="ui_pic">
											<img width="90" height="30" src="$VmUtils.randomPic('',$!spdiscount.limg)" />
										</div>
										<div class="ui_text">
											<span class="noto" id="title$spdiscount.id" lang='$!spdiscount.getFullEnableRemark($order.totalAmount, $discountAmountMap.get($spdiscount.id))'>$!spdiscount.getFullEnableRemark($order.totalAmount, $discountAmountMap.get($spdiscount.id))</span>
											<div lang="introduce$!spdiscount.id" class="note introduce" id="detail$spdiscount.id">
												<span>
													<span>$!spdiscount.description</span>
												</span>
												<em class="freeTag1"></em>
												<div data-type="tips" class="none">
													<p style="overflow:hidden;width:265px;">
													#if($VmUtils.isNotBlank($!spdiscount.adcontent))$!{spdiscount.adcontent}#{else}$!{spdiscount.description}#end															</p>
												</div>
											</div>	
										</div>
									</div>
								</div>
								<div class="none">
									<span>$!spdiscount.description</span>
									<span>$!spdiscount.timefrom 至 $!spdiscount.timeto</span>
									<span>$!spdiscount.getFullEnableRemark($order.totalAmount, $discountAmountMap.get($spdiscount.id))</span>
								</div>
								<span class="freeTag1 xz"></span>
								#if($order.discount gt 0)
								#elseif($maxSpdiscount && $VmUtils.isNotBlank($maxSpdiscount.recommendRemark) && $maxSpdiscount.id eq $spdiscount.id)
									<span class="freeTag1 rec"></span>
								#end
							</div>
							#end
							#end
						</dd>
					</dl>
					#end
				</div>
				<div class="peyments">
					<p class="fs14">
						#if($pointDiscount)
						<input type="hidden" name="reusepoint" value="true" />
						使用优惠：<span class="bold yellow" id="payMoney">你使用积分抵用了$pointDiscount.amount元</span><span class="unselect2" id="cancle" onclick="removeDiscount($pointDiscount.id);"></span>
						#elseif($VmUtils.size($cardDiscountList) gt 0)
						使用优惠：<span class="bold yellow" id="payMoney">使用$VmUtils.size($cardDiscountList)张优惠券</span> #foreach($discount in $cardDiscountList) #if($foreach.index eq 0)<span class="unselect2" onclick="removeCard($discount.id, '$cardMap.get($discount.id).cardno',this);" id="sale" #if($cardDiscountList.size() gt 1)style="visibility: hidden;"#end>#end #end</span>
						#elseif($partnerDiscount && $curSpdiscount)
							<!-- 使用在线银行支付 -->
							#foreach($spdiscount in $spdiscountList)
								#if($spdiscount.id eq $curSpdiscount.id)
								使用优惠：<span class="bold cf60" id="payMoney">$!curSpdiscount.remark</span><span class="unselect2" onclick="removeDiscount($partnerDiscount.id);" id="sale"></span>
								#end
							#end
						#else
						<em id="noyh" class="none">使用优惠：</em><span id="payMoney" class="bold cf60">没有使用优惠</span>
						<span class="unselect2"  id="sale" onclick="cancelSale();"  style="visibility: hidden;"></span>
						<span class="intro" id ="recommend">
							#if($order.discount gt 0)
							#elseif($maxSpdiscount && $VmUtils.isNotBlank($maxSpdiscount.recommendRemark))<label for="check$maxSpdiscount.flag" style="cursor: pointer;font-weight:normal;font-size:12px;margin-left:10px;text-decoration:underline;">
								推荐使用：$!VmUtils.htmlabbr($!maxSpdiscount.getFullRecommendRemark($order.totalAmount, $discountAmountMap.get($maxSpdiscount.id)),50)</label>
							#end
						</span>
						#end
						<label class="button maxBt redBt" style="vertical-align: middle;">
							<input type="button" class="bt1" value="确认订单，立即支付" onclick="gotoPay()"/>
						</label>
					</p>
				</div>
			</div>
		</div>
	</div>
</div>
<div id="showCard"style="display:none">
</div>
#if($item.openseat)
#set($pageTrack=${basePath} + 'drama/order/seatconfirm.html')
#else
#set($pageTrack=${basePath} + 'drama/order/confirm.html')
#end
#parse('include/global/bindMobile.vm')
<script type="text/javascript">
var storeList = "";
storeList = storeList?storeList.split(','):[];
var remain, pfun,radioList = $('discountPanel').getElements('input[type=radio][disable!=disable]');
window.addEvent('domready',function(){
	data();
	tabs();
	radioTab();
	if($('cardPanel'))$('cardPanel').getElements('input[type=text],.bt1').addEvent('focus',function(){
		if($("radio1").disabled) return;
		$("radio1").checked=true;
		resetAmount();
	});
	
	#if($VmUtils.gt($cardCount, 3))
	choiceOpiList();
	#end
	#if($orderOther.openCardPay)
		$('cardpass').addEvents({
			'focus':function(){$$('.cardpass').hide();radioManager("radio1");},
			'blur':function(){if(this.value == '')$$('.cardpass').show();}
		});
	#end
	
	#if(!$VmUtils.isEmptyList($spdiscountList))
		var tmpSpdiscount = $('officialActivities').getElements('div.enableds');
		tmpSpdiscount.addEvent('click',function(){
			var el = $(this.get('lang'));
			selSpdiscount(el.value, el, this.get('rel'));
		});
		$$('div.introduce').each(function(node){
			var tp = node.getElement('div[data-type=tips]');
			if(tp && tp.innerHTML != ""){
				node.amTips({content:function(){return tp.innerHTML;}.bind(node),ispointer:false,position:'bottom',center:false});
			}
		});
	#end
	#if($maxSpdiscount && $VmUtils.isNotBlank($maxSpdiscount.recommendRemark))
		$('recommend').getElement('label').addEvent('click',function(){
			var el = $(this.get('for'));
			selSpdiscount(el.value, el, this.get('rel'));
		});
	#end
	
	#if($orderOther.openPointPay && $memberpoint ge $orderOther.minpoint && !$pointDiscount)
	$$('.exeSub').addEvent('click',function(){
		radioManager("radio2");
		if(!$("radio2").checked) return;
		var el = $('usepoint'),value = el.value.toInt(),bigValue = ${orderOther.maxpoint};
		if(this.hasClass('sub')){
			value = value + 100;
			if(bigValue < value){
				el.value = bigValue;
			}else{
				el.value = value.toInt();
			}
		}else{
			value = value - 100;
			if(value.toInt() > ${orderOther.minpoint}){
				el.value = value.toInt();
			}else{
				el.value = ${orderOther.minpoint};
			}
		}
		setPointAmount();
	});
	$('radio2').addEvent('click',function(){
		setPointAmount();
	});
	radioList.each(function(item){
		item.addEvent('mouseup',function(){
			if(($('radio2') != item)){
				cancelSale();
			}
		})
	});
	$('usepoint').addEvent('change',function(){
		setPointAmount();
	});
	$("submitpoint").addEvent('click',function(){ 
		if($("radio2").disabled) return;
		setPointAmount();
	});
	#end
	#if($orderOther.greetings)
	new issue('greeting',{'font':'fontN','tips':'nt','num':10});
	#end
});
 
function data(){
	var random = (Math.random()*1000000).toInt();
	var pastTitle = '<div class="conitce"><em>对不起，订单已超时！</em><div class="mt10">座位或场次已被系统释放，请返回重新购买<br/>如果疑问请联系客服：4000-406-506</div></div>';
	new Request({
		url: '${basePath}cinema/order/time.xhtml?tid=$order.id&'+random,
		method:'get',
		onSuccess: function(responseText){
			remain = responseText * 1;
			if(remain <= 0){
				$("CountMsg").empty();
				$("CountMsg").innerHTML = "订单已超时";
				gewa.util.issure('','<div class="black">'+ pastTitle +'</div>','格瓦拉支付提示：',360,'orderPast',function(){
					gewa.util.container['orderPast'].dispose('orderPast');
					document.location.href = '${basePath}drama/$!drama.id';
				});
			}else{
				pfun = getRTime.periodical(1000);
			}
		}
	}).send();
}

function clearStyle(){
	var ids = $('officialActivities');
	if(ids && ids.getElements('div.enableds')){
		ids.getElements('div.enableds').removeClass('select');
	}
}
function selSpdiscount(spid, self, isGo){
	self = $(self);
	if(!self)return;//所有优惠都要经过self的验证(单选按钮)
	clearStyle();
	if(isGo == "Y"){
		bindMobile(function(){
			self.checked = true;
			self.getParent('div.enableds').removeClass('hover');
			self.getParent('div.enableds').addClass('select');
			isParmas(spid);
		},'本活动需要绑定手机：','对不起，此优惠需绑定手机号，请立即绑定');
	}else{
		self.checked = true;
		self.getParent('div.enableds').addClass('select');
		isParmas(spid);
	}
}
function isParmas(spid){
	$('recommend').empty();
	$('payMoney').innerHTML = $('title'+spid).innerHTML;
	//$('recommend').innerHTML = $('detail'+spid).innerHTML;
	$('sale').removeEvents("click");
	$('sale').addEvent("click",function(){cancelSale();}).fade(1);
	$('recommend').removeClass('none');
}

function choiceOpiList(){
	var tgheight = new Fx.Toggle('orderTable',{duration:400, link: 'cancel'}),toggleE = $('triggerPlug'),container = $('orderTable');
	var length = container.getElements('tr').length;
	container.setStyle('height',length*37 + 9);
	var defheight = (length>3?3:length)*37+9,exH = defheight;
	tgheight.init.height = exH;
	var exetoggleheight = function(){
		tgheight.toggleHeight(exH,function(){
			tgheight.init.height = (exH==defheight)?(length*37 + 33):defheight;
			var v1='收起',v2='展开',v3 = toggleE.get('text').indexOf(v2)<0?v2:v1,v4 = toggleE.get('text').indexOf(v2)==0?v2:v1;
			toggleE.set('text',toggleE.get('text').replace(v4,v3));
		});
	}
	if(toggleE){
		toggleE.addEvent('click', function(event) {
			exetoggleheight();
		});
		exetoggleheight();
	}
}

function radioManager(useRadio){//通过单选框关联操作项
	if(useRadio && $(useRadio)){
		if($(useRadio).disabled)return ;
		useRadio = $(useRadio) || ''
	}
	var radios = document.getElements("input[type=radio][name=discounttype]");
	var filtRadio = radios.filter(function(radio){
		return radio == useRadio;
	})
	if(filtRadio.length > 0){
		filtRadio[0].checked = true;
	}else{
		radios.each(function(radio){
			if(radio.retrieve('key') != null){
				if(radio.retrieve('key').length > 0){
					radio.retrieve('key').each(function(item){
						if($(item+'_bt'))$(item+'_bt').fireEvent('click');
					})
				}
				radio.store('key',null);
			}
			radio.checked = false;
			radio.set("disabled", false);
		})
	}
}
function disabledInput(items,el){//设置非当前单选为失效（不能使用）
	items.each(function(item){
		if(item != el){
			item.disabled = true;
		}else item.checked = true;
	})
}
function cancelSale(){ 
	clearStyle();
	$('payMoney').innerHTML = "请选择优惠方式";
	radioManager('');
	$('sale').fade(0);
	if($('submitpoint')) $('submitpoint').set('value','使用').removeClass('cancel bt2').addClass('bt1').removeEvents('click');
	if($('submitpoint')) $('submitpoint').addEvent('click',function(){ if($("radio2").disabled) return; setPointAmount();});
	if($('recommend'))$('recommend').addClass('none');
}
function setSaleInfo(html){
	clearStyle();
	$('payMoney').innerHTML = html;
	if(storeList.length > 1){
		$('sale').fade(0);
	}else{
		$('sale').fade(1);
	}
	if($('recommend'))$('recommend').addClass('none');
}
function setPointAmount(){//积分抵扣换算
	var deduct = $("usepoint").value.toInt()/100;
	var due = $order.totalAmount - deduct;
	setSaleInfo("使用"+$("usepoint").value+"积分抵值" + deduct +"元 ");
	$("useMoney").innerHTML = deduct;
	$('recommend').addClass('none');
	radioManager("radio2");
	$('submitpoint').removeEvents('click');
	$('submitpoint').addEvent('click',function(){ cancelSale();});
	$('submitpoint').set('value','取消').removeClass('bt1').addClass('cancel bt2');
}
function gotoPay(){
	#if($VmUtils.isNotBlank($opiOtherinfo.address))
		if($('mailName').value == ''){
			gewaUtil.alert('收件人不能为空！');
			return;
		}
		if($('mailAddress').value == ''){
			gewaUtil.alert('收件地址不能为空！');
			return;
		}
		if($('mailNo').value.length < 6 && $('mailNo').value.length != 0){
			gewaUtil.alert('邮编不格式不正确！');
			return ;
		}
	#end
	if($("radio1") && $("radio1").checked){
		if($('orderTable').getElements('input[type=button][value=取消]').length <= 0){
			cancelSale();
		}
	}
	gewa.util.mask({'element': "subBtParent",'title':'正在提交订单...'});
	var values = GewaraUtil.getValues("orderForm");
	GewaraUtil.sendRequest("${basePath}drama/order/saveOrderDis.xhtml", values, function(result){
		if(result.success){
			if(result.url) document.location.href="${basePath}" + result.url;
			else document.location.href="${basePath}gewapay/confirmOrder.xhtml?orderId=$order.id";
		}else{
			gewaUtil.alert(result.msg, function(){
				document.location.href="${basePath}gewapay/order.xhtml?orderId=$order.id";
			});
		}
	});
}
function getOrderMobile(){
	getText('mobile','el');
}
function modOrderMobile(){
	var values = {"orderid":$order.id,"mobile":$('mobile').value};
	GewaraUtil.sendRequest('${basePath}cinema/order/modOrderMobile.xhtml', values, function(result){
		if(result.success){
			$('mobileText').set('html',$('mobile').value);
			getText('mobile','el', 'true');
		}else{
			if(result.msg) gewaUtil.alert(result.msg);
		}
	});
}

function getOrderGreetings(){
	getText('greeting','btn_');
	$('fontN').removeClass('none');
}

function modOrderGreetings(){
	var oinputIndtext = $('greeting').value;
	if(oinputIndtext.length >10){
		gewaUtil.alert("个性化文字最多支持10个字!");
		return;
	}
	var values = {"orderId":$order.id,"greeting":oinputIndtext};
	GewaraUtil.sendRequest('${basePath}ajax/drama/saveGreetings.xhtml', values, function(result){
		if(result.success){
			$('greetingText').getElement('span').set('html',$('greeting').value);
			$('fontN').addClass('none');
			getText('greeting','btn_', 'true');
		}else{
			if(result.msg) gewaUtil.alert(result.msg);
		}
	});
}

function getText(){
	var args = arguments;
	var el1 = args[0],el2 = args[1], toggle = args[2];
	var toggles = $chk(toggle);
	var el1Text = $(el1 + 'Text');
	el1 = $(el1);
	if(el1 && el1Text){
		if(toggles){
			el1.addClass('none');
			el1Text.removeClass('none');
		}else{
			el1.removeClass('none');
			el1Text.addClass('none');
		}
	}
	var el2Get = $(el2 + 'Get'),el2Save = $(el2 + 'Save');
	if(el2Get && el2Save){
		if(toggles){
			el2Save.addClass('none');
			el2Get.removeClass('none');
		}else{
			el2Get.addClass('none');
			el2Save.removeClass('none');
		}
	}
}

function getOrderAddress(){
	$('modifyMailInfo').getElements('input[type="text"]').removeClass('none');
	$('modifyMailInfo').getElements('b').addClass('none');
	$('modifyAddress').addClass('none');
	$('saveAddress').removeClass('none');
}

function removeDiscount(did){
	GewaraUtil.sendRequest("${basePath}ajax/trade/removeDiscount.xhtml",{"orderId":$order.id, "discountId":did}, function(result){
		if(result.success) {
			document.location.href="${basePath}gewapay/order.xhtml?orderId=$order.id";
		}else{
			gewaUtil.alert(result.msg, function(){
				document.location.href="${basePath}gewapay/order.xhtml?orderId=$order.id";
			});
		}
	});
}
function removeCard(did, cardno, self){
	if($("radio1").disabled) return;
	var el = $("radio1");
	GewaraUtil.sendRequest("${basePath}ajax/trade/removeDiscount.xhtml",{"orderId":$order.id, "discountId":did}, function(result){
		if(result.success){
			storeList.erase(cardno);
			if(storeList.length < 2){$('sale').fade(1);}
			$(cardno).removeClass('select');
			$(cardno + "button").innerHTML = '<input type="button" value="使用" class="bt1" onclick="showCard(' + "'" + cardno + "'" + ',this);"/>';
			totalDiscount = result.totalDiscount;
			if(result.totalDiscount == 0){
				cancelSale();
			}
			if(!$$('.bt1').some(function(item){
				return item.hasClass('cancel');
			})){
				#if($order.discount gt 0)
				document.location.href="${basePath}gewapay/order.xhtml?orderId=$order.id";
				#else
				radioManager('');
				#end
			}
			if($('submitpoint')) $('submitpoint').removeClass('none');
		} else {
			gewaUtil.alert(result.msg);
		}
	});
}

function getRTime(){
	var nM = Math.floor(remain/(1000*60)) % 60;
	var nS = Math.floor(remain/1000) % 60;
	$("RemainM").innerHTML = (nM < 10 ? "0" : "") + nM;
	$("RemainS").innerHTML = (nS < 10 ? "0" : "") + nS;
	remain -= 1000;
	if(((remain/1000).toInt()*1000)%60000==0){
		$clear(pfun);
		data();
	}
	if(remain<=0){
		if(pfun) $clear(pfun);
		data();
		return;
	}
}

function tabs(){
	var elements = $$('.paymentTerm dl dt');
	if(elements && elements.length>0){
		elements.addEvent('click',function(){
			if(this.get('class')=='select'){
				this.removeClass('select');
				$(this.get('lang')).addClass('none');
			}else{
				elements.each(function(item){
					item.removeClass('select');
					if($(item.get('lang'))){
						$(item.get('lang')).addClass('none');
					}
				});
				this.addClass('select');
				$(this.get('lang')).removeClass('none');	
			}
		});
		#if($pointDiscount){
			$('creditsArrived').fireEvent('click');
		#elseif($VmUtils.size($cardDiscountList) gt 0)
			$('movieCard').fireEvent('click');
		#else
			elements[elements.length-1].fireEvent('click');
		#end
	}
}

function useCardByPass(cardpass,self){
	if(cardpass == ''){
		gewaUtil.alert('票券密码不能为空');
	}
	if($("radio1").disabled) return;
	var el = $(self).getParent('.msC').getElement('input[type=radio]');
	GewaraUtil.sendRequest("${basePath}drama/order/useCardByPass.xhtml",{"orderId":$order.id, "cardpass":cardpass, "tag":"password"}, function(result){
		if(result.success){
			totalDiscount = result.totalDiscount;
			totalAmount = result.totalAmount;
			disabledInput(radioList,el);
			var coupontype = "";
			if(result.type == "A"){
				if(result.exchangetype == "A"){
					coupontype = "橙券";
				}else if(result.exchangetype == "B"){
					coupontype = "蓝券";
				}else if(result.exchangetype == "D"){
					coupontype = "兑换券";
				}else if(result.exchangetype == "E"){
					coupontype = "IMAX券";
				}
			}else if(result.type == "B"){
				coupontype = "补差券";
			}else{
				coupontype = "抵值券";
			}
			if(!$(result.cardno)){//输入的密码存在于可用列表中
				new Element("tr",{
					"id": result.cardno,
					"html":'<td>' + result.cardno + '</td><td>' + result.validtime + '</td>' + '<td>' + coupontype + '</td><td id="' + result.cardno + 'amount"></td><td id="' + result.cardno + 'button" align="right"></td>'
				}).inject("cardTable", "top");
			}
			$(result.cardno+"amount").innerHTML = result.usage;
			//$(result.cardno+"button").innerHTML = '<input type="button" value="取消" class="bt2 cancel" onclick="removeCard(' + result.discountId + ", '" + result.cardno + "'" + ',this);"/>';
			$(result.cardno + "button").empty();
			var bt = new Element('input',{'type':'button','id':result.cardno+'_bt','value':'取消','class':'bt2 cancel'}).addEvent('click',function(){
				removeCard(result.discountId,result.cardno,this);
			}).inject(result.cardno + "button");
			result.bt = bt;
			storeList.push(result.cardno);
			el.store('key',storeList);
			
			setSaleInfo("使用" +result.count+"张" + coupontype + "，优惠：" + result.totalDiscount + "元。");
			if($('submitpoint')) $('submitpoint').addClass('none');
			$('orderTable').removeClass('none');
			$("cardpass").value="";
			if(result.bindGoods) {
				$("bindGoods").innerHTML = result.bindGoods;
				$("bindGoodsp").removeClass('none');
			}
			//自适应追加高度
			//if($('orderTable').getElements('tr').length > 5){gewaUtil.shutOpen($('orderTable'),$('plugtableInner').getDimensions().y);$('exeMore').show();}
		}else{
			if(result.activation){
				$('msgs').getElement('a').set('href','${basePath}home/acct/activationCard.xhtml?cardno='+result.msg);
				gewaUtil.maskContent('','msgs',"系统提示：",360,"bandCard");
			}else gewaUtil.alert(result.msg, function(){
				document.location.href="${basePath}gewapay/order.xhtml?orderId=$order.id";
			},'',300);
		}
	});
}
var selectIpunt = '';
function showCard(cardno, obj){
		var url="${basePath}ajax/member/rescindcard.xhtml";
		var values = {'cardno':cardno,'v':Date.now()};
		gewaUtil.loadData('showCard',url,values,function(result){
			if(result.success){
				gewa.util.issure('','showCard','输入支付密码',430,'showCard',function(){
					useCardByNo($!order.id, cardno);
				});
			}else{
				if(result.json.errorMap){
					gewa.util.issure('','setPayPassword','设置支付密码',420,'setPayPassword',function(){
						modifyPWD();
					});
				}else{
					gewaUtil.alert(result.json.msg);
				}
			}
		});
		selectIpunt = obj;
}

function radioTab(){
	var radioTab = $('radioTab').getElements('input[name=selectTicket]');	
	if(radioTab && radioTab.length>0){
		radioTab.addEvent('click',function(){
			radioTab.each(function(item){
				item.checked = false;
				var el = $(item.get('lang'));
				if(el){
					el.hide();
				}
			});
			this.checked = true;
			$(this.get('lang')).show();
			if(this.get('id') == 'expTicketInput'){
				if($('expressid'))$('expressid').getParent('span').show();
			}else{
				if($('expressid'))$('expressid').getParent('span').hide();
			}
		});
		#if($otherFeeMap.get('E'))
			$('expTicketInput').fireEvent('click');
			var elements = $('expressRadio').getElements("input[type=radio]");
			if(elements && elements.length == 1){
				elements[0].fireEvent('click');
			}
		#else
			radioTab[0].fireEvent('click');
		#end
	}
}

function hidenCard(cardno){
	if(gewa.util.container[cardno])gewa.util.container[cardno].dispose(cardno);
}
function useCardByNo(orderid,cardno){
	if($("radio1").disabled) return;
	var el = $("radio1");
	var url = '${basePath}drama/order/useElecCardByNo.xhtml';
	var values = {'orderId':orderid,'tag':'cardno','cardno':cardno,'password':$('password').value};
	if(values.password == ''){
		gewaUtil.alert('支付密码不能为空！');
		return;
	}
	GewaraUtil.sendRequest(url, values, function(result){
		if(result.success){
			hidenCard('showCard');
			totalDiscount = result.totalDiscount;
			totalAmount = result.totalAmount;
			disabledInput(radioList,el);
			$(result.cardno + "amount").innerHTML = result.usage;
			//$(result.cardno + "button").innerHTML = '<input type="button" value="取消" class="bt2 cancel" onclick="removeCard(' + result.discountId + ", '" + result.cardno + "'" + ',this);"/>';
			$(result.cardno + "button").empty();
			var bt = new Element('input',{'type':'button','id':result.cardno+'_bt','value':'取消','class':'bt2 cancel'}).addEvent('click',function(){
				removeCard(result.discountId,result.cardno,this);
			}).inject(result.cardno + "button");
			result.bt = bt;
			storeList.push(result.cardno);
			el.store('key',storeList);
			var coupontype = "";
			if(result.type == "A"){
				coupontype = "兑换券";
			}else{
				coupontype = "优惠券";
			}
			setSaleInfo("使用" +result.count+"张" + coupontype + "，优惠：" + result.totalDiscount + "元。");
			if($('submitpoint')) $('submitpoint').addClass('none');
			if($(selectIpunt)){
				$(selectIpunt).addClass('select');
			}
			if(result.bindGoods) {
				$("bindGoodsp").removeClass('none');
			}
		}else{
			if(result.activation){
				$('msgs').getElement('a').set('href','${basePath}home/acct/activationCard.xhtml?cardno='+result.msg);
				gewaUtil.maskContent('','msgs',"系统提示：",360,"bandCard");
			}else gewaUtil.alert(result.msg, function(){
				document.location.href="${basePath}gewapay/order.xhtml?orderId=$order.id";
			},'',300);
		}
	});
}

function resetAmount(){
	useCardByPass($('cardpass').value,$("radio1"));
}

</script>
#parse('include/wide_footer.vm')
</body>
</html>